machine:
  services:
    - docker
  post:
    - wget -qO- get.nextflow.io | bash ; chmod 755 nextflow ; sudo ln -s ~/nextflow /usr/local/bin/; sudo apt-get install graphviz
    - wget https://github.com/MaxUlysse/CAW-containers/blob/master/containers/gatk/GenomeAnalysisTK-3.7.tar.bz2?raw=true
    - git clone https://github.com/IARCbioinfo/data_test.git
    - wget https://github.com/broadinstitute/mutect/releases/download/1.1.5/muTect-1.1.5-bin.zip
    - sudo apt-get install bedtools
    - sudo add-apt-repository "deb http://cran.rstudio.com//bin/linux/debian jessie-cran3/"; sudo apt-get install --no-install-recommends -y r-base
test:
  override:
    - | #Unzip muTect-1 and test it with good java version (1.7)
      cd ~ && unzip muTect-1.1.5-bin.zip && /usr/lib/jvm/jdk1.7.0/bin/java -jar muTect-1.1.5.jar --help
    - | #Rename and untar GATK3.7
      cd ~ && mv GenomeAnalysisTK-3.7.tar.bz2?raw=true GenomeAnalysisTK.jar.tar.bz2 && tar -jxf GenomeAnalysisTK.jar.tar.bz2
    - | #Test GATK3.7
      cd ~ && chmod +x GenomeAnalysisTK.jar && java -jar GenomeAnalysisTK.jar --help
    - | #Launch muTect-1
      nextflow run ~/mutect-nf/mutect.nf --tumor_bam_folder ~/data_test/BAM/test/ --normal_bam_folder ~/data_test/BAM/test/ --bed ~/data_test/BED/TP53_exon2_11.bed --ref ~/data_test/REF/17.fasta --mutect_jar ~/muTect-1.1.5.jar --nsplit 2 --java /usr/lib/jvm/jdk1.7.0/bin/java -with-dag dag.png
    - | #Launch muTect-1(v2)
      nextflow run ~/mutect-nf/mutect.nf --tumor_bam_folder ~/data_test/BAM/test/ --normal_bam_folder ~/data_test/BAM/test/ --bed ~/data_test/BED/TP53_exon2_11.bed --ref ~/data_test/REF/17.fasta --mutect_jar ~/muTect-1.1.5.jar --nsplit 2 --java /usr/lib/jvm/jdk1.7.0/bin/java -with-dag dag.html
    - | #Launch muTect-2
      nextflow run ~/mutect-nf/mutect.nf --tumor_bam_folder ~/data_test/BAM/test/ --normal_bam_folder ~/data_test/BAM/test/ --bed ~/data_test/BED/TP53_exon2_11.bed --ref ~/data_test/REF/17.fasta --mutect2_jar ~/GenomeAnalysisTK.jar --nsplit 2 --out_folder mutect2_results
    - | #Check for results muTect-1
      ls ~/mutect-nf/mutect_results
    - | #Check for results muTect-2
      ls ~/mutect-nf/mutect2_results
deployment:
  git:
    branch: [master, dev]
    commands:
    - chmod +x deploy.sh && ./deploy.sh
